<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Editar servicios</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/editar_servicios.css') }}">
    <style>
        .marcado-eliminar {
            text-decoration: line-through;
            color: red;
        }
        .subtotal {
            min-width: 80px;
            display: inline-block;
        }
    </style>
</head>

<body>
    <h2>Editar servicios de la reserva #{{ reserva.id_reserva }}</h2>

    <form method="POST">
        <table class="tabla">
            <thead>
                <tr>
                    <th>Servicio</th>
                    <th>Cantidad</th>
                    <th>Subtotal</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody id="tabla-consumos">
                {% for c in consumos %}
                <tr data-id-consumo="{{ c.id_consumo }}" class="{% if c.marcado_eliminar %}marcado-eliminar{% endif %}">
                    <td>
                        <select name="id_servicio[]" {% if c.marcado_eliminar %}disabled{% endif %}>
                            {% for s in servicios %}
                            <option value="{{ s.id_servicio }}" data-precio="{{ s.precio }}"
                                {% if c.id_servicio == s.id_servicio %}selected{% endif %}>
                                {{ s.nombre }} - ${{ s.precio }}
                            </option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        <input type="number" name="cantidad[]" value="{{ c.cantidad }}" min="1"
                               {% if c.marcado_eliminar %}disabled{% endif %}>
                    </td>
                    <td class="subtotal">${{ c.subtotal }}</td>
                    <td>
                        {% if not c.marcado_eliminar %}
                        <button type="button" class="btn btn-danger btn-sm btn-marcar-eliminar">Eliminar</button>
                        {% else %}
                        Marcado para eliminar
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}

                <tr id="fila-nuevo-servicio">
                    <td>
                        <select id="nuevo-servicio">
                            <option value="">Selecciona servicio</option>
                            {% for s in servicios %}
                            <option value="{{ s.id_servicio }}" data-precio="{{ s.precio }}">
                                {{ s.nombre }} - ${{ s.precio }}
                            </option>
                            {% endfor %}
                        </select>
                    </td>
                    <td><input type="number" id="cantidad-nuevo" min="1"></td>
                    <td class="subtotal">—</td>
                    <td><button type="button" id="btn-agregar-temporal" class="btn btn-success btn-sm">Añadir</button></td>
                </tr>
            </tbody>
        </table>

        <div class="acciones" style="margin-top: 10px;">
            <button type="submit" name="accion" value="confirmar" class="btn btn-primary">
                Confirmar cambios
            </button>

            <button type="submit" name="accion" value="cancelar" class="btn btn-secondary">
                Cancelar cambios
            </button>
        </div>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const tabla = document.getElementById('tabla-consumos');

            function actualizarSubtotal(fila) {
                const cantidad = parseInt(fila.querySelector('input[name="cantidad[]"]')?.value) || parseInt(fila.querySelector('input[type="number"]')?.value) || 0;
                const select = fila.querySelector('select');
                if (!select) return;
                const precio = parseFloat(select.selectedOptions[0].dataset.precio) || 0;
                const subtotal = fila.querySelector('.subtotal');
                subtotal.textContent = '$' + (cantidad * precio).toFixed(2);
            }

            tabla.addEventListener('input', function (e) {
                if (e.target.name === 'cantidad[]') {
                    const fila = e.target.closest('tr');
                    actualizarSubtotal(fila);
                }
            });

            // Actualizar subtotal al cambiar servicio
            tabla.addEventListener('change', function (e) {
                if (e.target.tagName === 'SELECT') {
                    const fila = e.target.closest('tr');
                    actualizarSubtotal(fila);
                }
            });

            tabla.addEventListener('click', function (e) {
                if (e.target.classList.contains('btn-marcar-eliminar')) {
                    const fila = e.target.closest('tr');
                    fila.classList.add('marcado-eliminar');
                    fila.querySelectorAll('input, select, button').forEach(el => el.disabled = true);
                    fila.dataset.marcarEliminar = 'true';
                }
            });

            document.getElementById('btn-agregar-temporal').addEventListener('click', function () {
                const select = document.getElementById('nuevo-servicio');
                const cantidadInput = document.getElementById('cantidad-nuevo');
                const cantidad = parseInt(cantidadInput.value);

                if (!select.value || cantidad <= 0) {
                    return alert("Selecciona un servicio válido y cantidad mayor a 0");
                }

                const precio = parseFloat(select.selectedOptions[0].dataset.precio);
                const nombre = select.selectedOptions[0].text.split(' - ')[0];

                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td>${nombre}<input type="hidden" name="id_servicio_nuevo[]" value="${select.value}"></td>
                    <td>${cantidad}<input type="hidden" name="cantidad_nuevo[]" value="${cantidad}"></td>
                    <td class="subtotal">$${(cantidad * precio).toFixed(2)}</td>
                    <td><button type="button" class="btn btn-danger btn-sm btn-marcar-eliminar">Eliminar</button></td>
                `;
                tabla.appendChild(fila);

                select.value = '';
                cantidadInput.value = '';
            });
        });
    </script>
</body>
</html>
